<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Home Energy System Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        
        .result-card h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 500;
            color: #495057;
        }
        
        .result-value {
            font-weight: 700;
            color: #007bff;
            font-size: 1.1rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .chart-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
        }
        
        .chart {
            width: 100%;
            height: 250px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .export-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .methodology {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .methodology h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .methodology p {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† California Home Energy System Calculator</h1>
            <p>Complete sizing for Solar, Battery (400V DC), Heat Pump, and EV Charging Systems</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2>House Configuration</h2>
                <div class="input-group">
                    <div class="form-group">
                        <label for="houseSize">House Size (sq ft)</label>
                        <input type="number" id="houseSize" value="2000" min="100" max="4000">
                    </div>
                    <div class="form-group">
                        <label for="climateZone">California Climate Zone</label>
                        <select id="climateZone">
                            <option value="coastal">Coastal (Mild)</option>
                            <option value="inland">Inland Valley (Moderate)</option>
                            <option value="desert">Desert (Hot)</option>
                            <option value="mountain">Mountain (Cold)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="insulationLevel">Insulation Level</label>
                        <select id="insulationLevel">
                            <option value="excellent">Excellent (New/Upgraded)</option>
                            <option value="good">Good (1990-2010)</option>
                            <option value="average">Average (1980-1990)</option>
                            <option value="poor">Poor (Pre-1980)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="occupants">Number of Occupants</label>
                        <input type="number" id="occupants" value="3" min="1" max="10">
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="form-group">
                        <label for="backupDays">Desired Backup Days</label>
                        <input type="number" id="backupDays" value="3" min="1" max="7">
                    </div>
                    <div class="form-group">
                        <label for="evCharging">EV Charging Needed</label>
                        <select id="evCharging">
                            <option value="none">No EV</option>
                            <option value="level1">Level 1 (120V)</option>
                            <option value="level2">Level 2 (240V)</option>
                            <option value="dcfast">DC Fast Charge</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="poolSpa">Pool/Spa</label>
                        <select id="poolSpa">
                            <option value="none">None</option>
                            <option value="small">Small Pool/Spa</option>
                            <option value="large">Large Pool</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="homeType">Home Type</label>
                        <select id="homeType">
                            <option value="allElectric">All Electric</option>
                            <option value="mixedFuel">Mixed Fuel (Gas+Electric)</option>
                            <option value="gasBackup">Electric with Gas Backup</option>
                        </select>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateSystems()">Calculate Energy Systems</button>
            </div>
            
            <div id="results" style="display: none;">
                <div class="results-grid">
                    <div class="result-card">
                        <h3>‚ö° Energy Consumption</h3>
                        <div id="energyResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>‚òÄÔ∏è Solar Array System</h3>
                        <div id="solarResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>üìê Solar Array Area</h3>
                        <div id="solarAreaResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>üîã Battery Storage System</h3>
                        <div id="batteryResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>üîå Power Inverter</h3>
                        <div id="inverterResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>üå°Ô∏è Heat Pump System</h3>
                        <div id="heatPumpResults"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3>üöó EV Charger</h3>
                        <div id="evResults"></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 style="text-align: center; color: #007bff; margin-bottom: 20px;">üìä Seasonal Energy Production vs Consumption</h3>
                    <div class="chart-grid">
                        <div class="chart-box">
                            <div class="chart-title">Spring (March)</div>
                            <canvas class="chart" id="springChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title">Summer (June)</div>
                            <canvas class="chart" id="summerChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title">Autumn (September)</div>
                            <canvas class="chart" id="autumnChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <div class="chart-title">Winter (December)</div>
                            <canvas class="chart" id="winterChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="export-section">
                    <button class="export-btn" onclick="exportToCSV()">üìä Export to CSV</button>
                    <button class="export-btn" onclick="exportToGoogleSheets()">üìã Export to Google Sheets</button>
                    <button class="export-btn" onclick="printReport()">üñ®Ô∏è Print Report</button>
                </div>
            </div>
            
            <div class="methodology">
                <h3>üìã Calculation Methodology</h3>
                <p><strong>Energy Consumption:</strong> Based on CA average of 0.49 kWh per sq ft per month, adjusted for climate zone, insulation, occupancy, and appliances.</p>
                <p><strong>Solar Sizing:</strong> Calculated at ~1kW per 100 sq ft (10W/sq ft) as industry standard, with 25% safety margin and consideration of CA Title 24 requirements.</p>
                <p><strong>Solar Area:</strong> Based on 400W panels (79" x 39" each = 21.4 sq ft per panel) with 15% spacing factor for installation clearances.</p>
                <p><strong>Battery Storage:</strong> Sized for desired backup days with 90% depth of discharge for lithium batteries using 400V DC architecture, includes inverter efficiency losses.</p>
                <p><strong>Heat Pump:</strong> Sized using kW ratings based on climate zone and insulation (6-12 kW typical range for heating/cooling), with proper kW values for US 120V/240V systems.</p>
                <p><strong>Inverter:</strong> Sized for 125% of peak load to handle surge requirements and future expansion.</p>
                <p><strong>EV Charging:</strong> Based on average 36.9 miles/day driving with 3.2 miles/kWh efficiency (includes charging losses). Level 1 (1.4kW@120V), Level 2 (7.2kW@240V), DC Fast (50kW@480V). EV charging typically occurs during off-peak hours (11PM-6AM) for cost savings.</p>
                <p><strong>Seasonal Charts:</strong> Based on real California solar irradiance data - Summer peaks at 1.8x average, Winter drops to 0.4x average, with typical daily consumption patterns.</p>
            </div>
        </div>
    </div>

    <script>
        let calculationResults = {};

        function calculateSystems() {
            const houseSize = parseFloat(document.getElementById('houseSize').value);
            const climateZone = document.getElementById('climateZone').value;
            const insulationLevel = document.getElementById('insulationLevel').value;
            const occupants = parseInt(document.getElementById('occupants').value);
            const backupDays = parseInt(document.getElementById('backupDays').value);
            const evCharging = document.getElementById('evCharging').value;
            const poolSpa = document.getElementById('poolSpa').value;
            const homeType = document.getElementById('homeType').value;

            // Climate zone multipliers
            const climateMultipliers = {
                coastal: 0.85,
                inland: 1.0,
                desert: 1.35,
                mountain: 1.1
            };

            // Insulation multipliers
            const insulationMultipliers = {
                excellent: 0.8,
                good: 0.9,
                average: 1.0,
                poor: 1.3
            };

            // Base energy consumption (kWh per sq ft per month)
            const baseConsumption = 0.49;
            
            // Calculate monthly energy consumption
            const monthlyConsumption = houseSize * baseConsumption * 
                climateMultipliers[climateZone] * 
                insulationMultipliers[insulationLevel] * 
                (1 + (occupants - 3) * 0.15); // Adjust for occupancy

            // Add additional loads
            let additionalLoad = 0;
            if (poolSpa === 'small') additionalLoad += 300;
            if (poolSpa === 'large') additionalLoad += 600;
            if (homeType === 'allElectric') additionalLoad += monthlyConsumption * 0.4; // 40% more for all-electric

            // Add EV charging consumption
            let evDailyConsumption = 0;
            if (evCharging !== 'none') {
                // Real-world EV data: Average 36.9 miles/day for US drivers
                const dailyMiles = 36.9;
                // Average EV efficiency: 3.2 miles per kWh (includes charging losses)
                const milesPerKwh = 3.2;
                evDailyConsumption = dailyMiles / milesPerKwh; // ~11.5 kWh/day
            }

            const totalMonthlyConsumption = monthlyConsumption + additionalLoad + (evDailyConsumption * 30);
            const dailyConsumption = totalMonthlyConsumption / 30;
            const annualConsumption = totalMonthlyConsumption * 12;

            // Solar system sizing (industry standard: ~1kW per 100 sq ft = 10W per sq ft)
            const solarSystemSize = (houseSize / 100) * 1.25; // 25% safety margin
            const solarPanelCount = Math.ceil(solarSystemSize * 1000 / 400); // 400W panels
            const solarChargerAmps = Math.ceil(solarSystemSize * 1000 / 400 / 10); // 400V system, C/10 charge rate

            // Solar area calculations (400W panels: 79" x 39" = 21.4 sq ft each)
            const panelArea = 21.4; // sq ft per 400W panel
            const totalPanelArea = solarPanelCount * panelArea;
            const installationArea = totalPanelArea * 1.15; // 15% spacing factor
            const roofAreaNeeded = installationArea * 1.3; // 30% additional for layout efficiency

            // Battery storage sizing (400V DC architecture)
            const batteryCapacityKwh = dailyConsumption * backupDays / 0.9; // 90% DoD for lithium
            const batteryCapacityAh = batteryCapacityKwh * 1000 / 400; // 400V system
            const numberOfBatteries = Math.ceil(batteryCapacityKwh / 20); // 20kWh per battery unit (typical for 400V systems)

            // Inverter sizing (125% of peak load)
            const peakLoad = dailyConsumption * 1000 / 8; // Assume 8-hour peak usage window
            const inverterSize = Math.ceil(peakLoad * 1.25 / 1000) * 1000; // Round up to nearest kW

            // Heat pump sizing (kW-based for US systems)
            let heatPumpKw;
            const baseKwPerSqFt = climateZone === 'desert' ? 0.012 : 
                                 climateZone === 'mountain' ? 0.014 : 
                                 climateZone === 'coastal' ? 0.008 : 0.010;
            
            heatPumpKw = Math.ceil((houseSize * baseKwPerSqFt * insulationMultipliers[insulationLevel]) * 2) / 2; // Round to nearest 0.5 kW
            heatPumpKw = Math.max(6, Math.min(heatPumpKw, 12)); // Constrain to typical residential range

            const heatPumpBtu = heatPumpKw * 3412; // Convert kW to BTU/hr
            const heatPumpTons = heatPumpKw * 3412 / 12000; // Convert to tons

            // EV Charger specifications (US standards)
            const evSpecs = {
                none: { power: 0, voltage: 0, amps: 0, type: 'None' },
                level1: { power: 1.4, voltage: 120, amps: 12, type: 'Level 1 (Standard)' },
                level2: { power: 7.2, voltage: 240, amps: 30, type: 'Level 2 (Fast)' },
                dcfast: { power: 50, voltage: 480, amps: 104, type: 'DC Fast Charge' }
            };

            // Store results
            calculationResults = {
                houseSize,
                climateZone,
                insulationLevel,
                occupants,
                backupDays,
                evCharging,
                evDailyConsumption: evDailyConsumption.toFixed(1),
                dailyConsumption: dailyConsumption.toFixed(1),
                monthlyConsumption: totalMonthlyConsumption.toFixed(0),
                annualConsumption: annualConsumption.toFixed(0),
                solarSystemSize: solarSystemSize.toFixed(1),
                solarPanelCount,
                solarChargerAmps,
                totalPanelArea: totalPanelArea.toFixed(0),
                installationArea: installationArea.toFixed(0),
                roofAreaNeeded: roofAreaNeeded.toFixed(0),
                batteryCapacityKwh: batteryCapacityKwh.toFixed(1),
                batteryCapacityAh: batteryCapacityAh.toFixed(0),
                numberOfBatteries,
                inverterSize,
                heatPumpKw: heatPumpKw.toFixed(1),
                heatPumpBtu: heatPumpBtu.toFixed(0),
                heatPumpTons: heatPumpTons.toFixed(1),
                evSpecs: evSpecs[evCharging]
            };

            displayResults();
            createSeasonalCharts();
        }

        function displayResults() {
            document.getElementById('results').style.display = 'block';

            // Energy Results
            document.getElementById('energyResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">Daily Consumption:</span>
                    <span class="result-value">${calculationResults.dailyConsumption} kWh</span>
                </div>
                ${calculationResults.evCharging !== 'none' ? `
                <div class="result-item">
                    <span class="result-label">EV Daily Charging:</span>
                    <span class="result-value">${calculationResults.evDailyConsumption} kWh</span>
                </div>` : ''}
                <div class="result-item">
                    <span class="result-label">Monthly Consumption:</span>
                    <span class="result-value">${calculationResults.monthlyConsumption} kWh</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Annual Consumption:</span>
                    <span class="result-value">${calculationResults.annualConsumption} kWh</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Peak Load Estimate:</span>
                    <span class="result-value">${(calculationResults.dailyConsumption * 1000 / 8).toFixed(0)} W</span>
                </div>
            `;

            // Solar Results
            document.getElementById('solarResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">System Size:</span>
                    <span class="result-value">${calculationResults.solarSystemSize} kW</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Panel Count (400W):</span>
                    <span class="result-value">${calculationResults.solarPanelCount} panels</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Charge Controller:</span>
                    <span class="result-value">${calculationResults.solarChargerAmps}A MPPT</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Estimated Annual Generation:</span>
                    <span class="result-value">${(calculationResults.solarSystemSize * 1460).toFixed(0)} kWh</span>
                </div>
            `;

            // Solar Area Results
            document.getElementById('solarAreaResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">Panel Area (79"√ó39"):</span>
                    <span class="result-value">${calculationResults.totalPanelArea} sq ft</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Installation Area:</span>
                    <span class="result-value">${calculationResults.installationArea} sq ft</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Roof Area Needed:</span>
                    <span class="result-value">${calculationResults.roofAreaNeeded} sq ft</span>
                </div>
                <div class="result-item">
                    <span class="result-label">% of House Size:</span>
                    <span class="result-value">${(calculationResults.roofAreaNeeded / calculationResults.houseSize * 100).toFixed(1)}%</span>
                </div>
            `;

            // Battery Results
            document.getElementById('batteryResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">Total Capacity:</span>
                    <span class="result-value">${calculationResults.batteryCapacityKwh} kWh</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Battery Bank (400V):</span>
                    <span class="result-value">${calculationResults.batteryCapacityAh} Ah</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Number of Batteries:</span>
                    <span class="result-value">${calculationResults.numberOfBatteries} units</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Backup Duration:</span>
                    <span class="result-value">${calculationResults.backupDays} days</span>
                </div>
            `;

            // Inverter Results
            document.getElementById('inverterResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">Inverter Size:</span>
                    <span class="result-value">${calculationResults.inverterSize} W</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Type Recommended:</span>
                    <span class="result-value">Pure Sine Wave</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Voltage:</span>
                    <span class="result-value">400V DC to 120V/240V AC</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Grid Tie Capability:</span>
                    <span class="result-value">Hybrid Inverter</span>
                </div>
            `;

            // Heat Pump Results
            document.getElementById('heatPumpResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">System Size:</span>
                    <span class="result-value">${calculationResults.heatPumpKw} kW</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Heating/Cooling Capacity:</span>
                    <span class="result-value">${calculationResults.heatPumpBtu} BTU/hr</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Tonnage:</span>
                    <span class="result-value">${calculationResults.heatPumpTons} tons</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Voltage:</span>
                    <span class="result-value">240V AC (US Standard)</span>
                </div>
            `;

            // EV Results
            document.getElementById('evResults').innerHTML = `
                <div class="result-item">
                    <span class="result-label">Charger Type:</span>
                    <span class="result-value">${calculationResults.evSpecs.type}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Power Rating:</span>
                    <span class="result-value">${calculationResults.evSpecs.power} kW</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Voltage:</span>
                    <span class="result-value">${calculationResults.evSpecs.voltage}V</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Current Draw:</span>
                    <span class="result-value">${calculationResults.evSpecs.amps}A</span>
                </div>
            `;
        }

        function createSeasonalCharts() {
            const dailyConsumption = parseFloat(calculationResults.dailyConsumption);
            const solarSystemSize = parseFloat(calculationResults.solarSystemSize);
            
            // Real California seasonal solar production data (kWh per kW per day)
            // Based on NREL data and actual CA installations
            const seasonalProduction = {
                spring: solarSystemSize * 4.8,   // March: ~4.8 kWh/kW/day
                summer: solarSystemSize * 6.2,   // June: Peak ~6.2 kWh/kW/day  
                autumn: solarSystemSize * 4.1,   // September: ~4.1 kWh/kW/day
                winter: solarSystemSize * 2.8    // December: Lowest ~2.8 kWh/kW/day
            };
            
                                // Real CA residential consumption patterns by season
            const seasonalConsumption = {
                spring: dailyConsumption * 0.85,  // Mild weather, minimal HVAC
                summer: dailyConsumption * 1.25,  // High AC usage (4-9pm peak)
                autumn: dailyConsumption * 0.8,   // Comfortable weather
                winter: dailyConsumption * 1.1    // Some heating, shorter days
            };
            
            // EV charging patterns (if EV is selected)
            const evConsumption = parseFloat(calculationResults.evDailyConsumption) || 0;
            
            const seasons = ['spring', 'summer', 'autumn', 'winter'];
            const chartIds = ['springChart', 'summerChart', 'autumnChart', 'winterChart'];
            
            seasons.forEach((season, index) => {
                const canvas = document.getElementById(chartIds[index]);
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Set canvas size
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const totalDailyProduction = seasonalProduction[season];
                const totalDailyConsumption = seasonalConsumption[season];
                
                // Create hourly data (24 hours) based on real CA patterns
                const hours = [];
                const production = [];
                const consumption = [];
                
                for (let h = 0; h < 24; h++) {
                    hours.push(h);
                    
                    // Real solar production curve - starts at sunrise, peaks at noon
                    let prodValue = 0;
                    if (season === 'summer' && h >= 5 && h <= 19) {
                        // Summer: longer days, 5am-7pm production
                        const normalizedHour = (h - 12) / 7; // Center at noon, 7-hour spread
                        prodValue = (totalDailyProduction / 12) * Math.exp(-Math.pow(normalizedHour, 2) / 0.5);
                    } else if (season === 'winter' && h >= 7 && h <= 17) {
                        // Winter: shorter days, 7am-5pm production  
                        const normalizedHour = (h - 12) / 5; // Center at noon, 5-hour spread
                        prodValue = (totalDailyProduction / 8) * Math.exp(-Math.pow(normalizedHour, 2) / 0.4);
                    } else if ((season === 'spring' || season === 'autumn') && h >= 6 && h <= 18) {
                        // Spring/Fall: moderate days, 6am-6pm production
                        const normalizedHour = (h - 12) / 6; // Center at noon, 6-hour spread
                        prodValue = (totalDailyProduction / 10) * Math.exp(-Math.pow(normalizedHour, 2) / 0.45);
                    }
                    production.push(Math.max(0, prodValue));
                    
                    // Real CA residential consumption patterns
                    let consValue = (totalDailyConsumption - evConsumption) / 24 * 0.4; // Base load (24/7 appliances)
                    
                    // Morning peak (7-9am): getting ready for work/school
                    if (h >= 7 && h <= 9) {
                        consValue += (totalDailyConsumption - evConsumption) * 0.08;
                    }
                    // Midday (10am-3pm): moderate usage
                    else if (h >= 10 && h <= 15) {
                        consValue += (totalDailyConsumption - evConsumption) * 0.04;
                    }
                    // California peak hours (4-9pm): highest consumption
                    else if (h >= 16 && h <= 21) {
                        if (season === 'summer') {
                            consValue += (totalDailyConsumption - evConsumption) * 0.12; // High AC usage
                        } else {
                            consValue += (totalDailyConsumption - evConsumption) * 0.08; // Normal evening peak
                        }
                    }
                    // Late evening (10pm-12am): winding down
                    else if (h >= 22 && h <= 23) {
                        consValue += (totalDailyConsumption - evConsumption) * 0.03;
                    }
                    // Night (1am-6am): minimal usage
                    else if (h >= 1 && h <= 6) {
                        consValue = (totalDailyConsumption - evConsumption) / 24 * 0.25;
                    }
                    
                    // Add EV charging (typically 11pm-6am for off-peak rates)
                    if (evConsumption > 0 && ((h >= 23) || (h >= 0 && h <= 6))) {
                        // Spread EV charging over 8 hours (11pm-7am)
                        consValue += evConsumption / 8;
                    }
                    
                    consumption.push(consValue);
                }
                
                drawChart(ctx, canvas, hours, production, consumption, season);
            });
        }
        
        function drawChart(ctx, canvas, hours, production, consumption, season) {
            const width = canvas.width;
            const height = canvas.height;
            const padding = 50;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // Find max value for scaling
            const maxProduction = Math.max(...production);
            const maxConsumption = Math.max(...consumption);
            const maxValue = Math.max(maxProduction, maxConsumption) * 1.15;
            
            // Draw background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            
            // Vertical grid lines (hours)
            for (let i = 0; i <= 24; i += 6) {
                const x = padding + (i / 24) * chartWidth;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
            }
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Fill area under production curve (light green)
            ctx.fillStyle = 'rgba(40, 167, 69, 0.2)';
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            for (let i = 0; i < hours.length; i++) {
                const x = padding + (i / 23) * chartWidth;
                const y = height - padding - (production[i] / maxValue) * chartHeight;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(padding + chartWidth, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Fill area under consumption curve (light red)
            ctx.fillStyle = 'rgba(220, 53, 69, 0.2)';
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            for (let i = 0; i < hours.length; i++) {
                const x = padding + (i / 23) * chartWidth;
                const y = height - padding - (consumption[i] / maxValue) * chartHeight;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(padding + chartWidth, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw production line (green)
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let i = 0; i < hours.length; i++) {
                const x = padding + (i / 23) * chartWidth;
                const y = height - padding - (production[i] / maxValue) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Draw consumption line (red)
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let i = 0; i < hours.length; i++) {
                const x = padding + (i / 23) * chartWidth;
                const y = height - padding - (consumption[i] / maxValue) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Highlight California peak hours (4-9pm) and EV charging hours
            if (season === 'summer' || season === 'winter') {
                // Peak hours (4-9pm)
                ctx.fillStyle = 'rgba(255, 193, 7, 0.3)';
                const peakStartX = padding + (16 / 24) * chartWidth; // 4pm
                const peakEndX = padding + (21 / 24) * chartWidth;   // 9pm
                ctx.fillRect(peakStartX, padding, peakEndX - peakStartX, chartHeight);
                
                // Peak hours label
                ctx.fillStyle = '#856404';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('CA Peak Hours', peakStartX + 5, padding + 20);
                ctx.fillText('(4-9 PM)', peakStartX + 5, padding + 35);
            }
            
            // Highlight EV charging hours (11pm-6am) if EV is selected
            if (parseFloat(calculationResults.evDailyConsumption) > 0) {
                ctx.fillStyle = 'rgba(13, 202, 240, 0.2)';
                const evStartX1 = padding + (23 / 24) * chartWidth; // 11pm
                const evEndX1 = padding + chartWidth;               // midnight
                const evStartX2 = padding;                          // midnight
                const evEndX2 = padding + (6 / 24) * chartWidth;   // 6am
                
                ctx.fillRect(evStartX1, padding, evEndX1 - evStartX1, chartHeight);
                ctx.fillRect(evStartX2, padding, evEndX2 - evStartX2, chartHeight);
                
                // EV charging label
                ctx.fillStyle = '#0a5a6b';
                ctx.font = 'bold 10px Arial';
                ctx.fillText('EV Charging', evStartX2 + 5, padding + 55);
                ctx.fillText('(11PM-6AM)', evStartX2 + 5, padding + 70);
            }
            
            // Draw axes
            ctx.strokeStyle = '#495057';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Add labels
            ctx.fillStyle = '#495057';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // Hour labels
            for (let i = 0; i <= 24; i += 6) {
                const x = padding + (i / 24) * chartWidth;
                ctx.fillText(i === 0 ? '12AM' : i === 12 ? '12PM' : i > 12 ? (i-12)+'PM' : i+'AM', x, height - padding + 25);
            }
            
            // Y-axis labels (kW)
            ctx.textAlign = 'right';
            ctx.font = '11px Arial';
            for (let i = 0; i <= 5; i++) {
                const y = height - padding - (i / 5) * chartHeight;
                const value = (maxValue * i / 5).toFixed(1);
                ctx.fillText(value + ' kW', padding - 10, y + 4);
            }
            
            // Y-axis title
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Power (kW)', 0, 0);
            ctx.restore();
            
            // X-axis title
            ctx.textAlign = 'center';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Time of Day', width / 2, height - 5);
            
            // Calculate and display daily totals
            const totalProduction = production.reduce((sum, val) => sum + val, 0);
            const totalConsumption = consumption.reduce((sum, val) => sum + val, 0);
            const netExcess = totalProduction - totalConsumption;
            
            // Daily summary box
            ctx.fillStyle = 'rgba(248, 249, 250, 0.95)';
            ctx.fillRect(width - 180, padding + 10, 170, 90);
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            ctx.strokeRect(width - 180, padding + 10, 170, 90);
            
            ctx.fillStyle = '#495057';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Daily Summary:', width - 175, padding + 25);
            
            ctx.font = '10px Arial';
            ctx.fillStyle = '#28a745';
            ctx.fillText(`Production: ${totalProduction.toFixed(1)} kWh`, width - 175, padding + 42);
            ctx.fillStyle = '#dc3545';
            ctx.fillText(`Consumption: ${totalConsumption.toFixed(1)} kWh`, width - 175, padding + 57);
            
            ctx.fillStyle = netExcess >= 0 ? '#28a745' : '#dc3545';
            ctx.font = 'bold 10px Arial';
            ctx.fillText(`Net: ${netExcess >= 0 ? '+' : ''}${netExcess.toFixed(1)} kWh`, width - 175, padding + 75);
            
            if (netExcess >= 0) {
                ctx.fillStyle = '#666';
                ctx.font = '9px Arial';
                ctx.fillText('(Surplus to grid)', width - 175, padding + 90);
            } else {
                ctx.fillStyle = '#666';
                ctx.font = '9px Arial';
                ctx.fillText('(Grid import needed)', width - 175, padding + 90);
            }
            
            // Legend
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#28a745';
            ctx.fillText('‚óè Solar Production', width - 180, height - 55);
            ctx.fillStyle = '#dc3545';
            ctx.fillText('‚óè Home Consumption', width - 180, height - 40);
            
            if (parseFloat(calculationResults.evDailyConsumption) > 0) {
                ctx.fillStyle = '#0dcaf0';
                ctx.font = '11px Arial';
                ctx.fillText('‚óè EV Charging (11PM-6AM)', width - 180, height - 25);
            }
        }

        function exportToCSV() {
            const csvData = [
                ['Parameter', 'Value', 'Unit'],
                ['House Size', calculationResults.houseSize, 'sq ft'],
                ['Climate Zone', calculationResults.climateZone, ''],
                ['Insulation Level', calculationResults.insulationLevel, ''],
                ['Occupants', calculationResults.occupants, 'people'],
                ['Daily Energy Consumption', calculationResults.dailyConsumption, 'kWh'],
                ['EV Daily Charging', calculationResults.evDailyConsumption, 'kWh'],
                ['Monthly Energy Consumption', calculationResults.monthlyConsumption, 'kWh'],
                ['Annual Energy Consumption', calculationResults.annualConsumption, 'kWh'],
                ['Solar System Size', calculationResults.solarSystemSize, 'kW'],
                ['Solar Panel Count', calculationResults.solarPanelCount, 'panels'],
                ['Solar Charge Controller', calculationResults.solarChargerAmps, 'A'],
                ['Total Panel Area', calculationResults.totalPanelArea, 'sq ft'],
                ['Installation Area', calculationResults.installationArea, 'sq ft'],
                ['Roof Area Needed', calculationResults.roofAreaNeeded, 'sq ft'],
                ['Battery Capacity', calculationResults.batteryCapacityKwh, 'kWh'],
                ['Battery Bank', calculationResults.batteryCapacityAh, 'Ah'],
                ['Number of Batteries', calculationResults.numberOfBatteries, 'units'],
                ['Inverter Size', calculationResults.inverterSize, 'W'],
                ['Heat Pump Size', calculationResults.heatPumpKw, 'kW'],
                ['Heat Pump Capacity', calculationResults.heatPumpBtu, 'BTU/hr'],
                ['Heat Pump Tonnage', calculationResults.heatPumpTons, 'tons'],
                ['EV Charger Type', calculationResults.evSpecs.type, ''],
                ['EV Charger Power', calculationResults.evSpecs.power, 'kW'],
                ['Backup Days', calculationResults.backupDays, 'days']
            ];

            let csvContent = "data:text/csv;charset=utf-8,";
            csvData.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "energy_system_calculation.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToGoogleSheets() {
            const sheetsUrl = `https://docs.google.com/spreadsheets/create`;
            window.open(sheetsUrl, '_blank');
            
            // Copy data to clipboard
            const data = Object.entries(calculationResults).map(([key, value]) => `${key}: ${value}`).join('\n');
            navigator.clipboard.writeText(data).then(() => {
                alert('Calculation data copied to clipboard! Paste it into your new Google Sheet.');
            });
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
